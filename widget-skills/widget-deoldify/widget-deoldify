#!/bin/bash
# widget-deoldify - Deoldify - Colorize old black & white photos
# Note: Some image sources (Wikipedia, Unsplash) may be blocked. Pexels images work well.

set -e

WIDGET_ID="1743838685868068864"

# Read config from myshell-config.json
MYSHELL_CONFIG="/root/.clawdbot/myshell-config.json"
if [ -f "$MYSHELL_CONFIG" ]; then
  API_BASE=$(jq -r '.openapi.host // "https://openapi-test.myshell.fun"' "$MYSHELL_CONFIG")
  API_KEY=$(jq -r '.openapi.request_headers["x-myshell-openapi-key"] // empty' "$MYSHELL_CONFIG")
  USER_ID=$(jq -r '.openapi.request_headers["x-myshell-openapi-user-id"] // .myshell_user_id // 3568326' "$MYSHELL_CONFIG")
else
  API_BASE="${WIDGET_API_BASE:-https://openapi-test.myshell.fun}"
  API_KEY="${WIDGET_API_KEY}"
  USER_ID="${MYSHELL_USER_ID:-3568326}"
fi

OUTPUT=""
INPUT_IMAGE=""
MODEL_NAME="Artistic"  # Default to Artistic (must be capitalized)
RENDER_FACTOR=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -o|--output) OUTPUT="$2"; shift 2 ;;
    --input_image) INPUT_IMAGE="$2"; shift 2 ;;
    --model_name) MODEL_NAME="$2"; shift 2 ;;
    --render_factor) RENDER_FACTOR="$2"; shift 2 ;;
    -h|--help)
      echo "Usage: widget-deoldify [options] <image_url>"
      echo ""
      echo "Colorize old black & white photos using AI."
      echo ""
      echo "Options:"
      echo "  -o, --output FILE      Save output to file"
      echo "  --input_image URL      Input image URL (black & white photo)"
      echo "  --model_name MODEL     'Artistic' or 'Stable' (default: Artistic)"
      echo "                         - Artistic: More vibrant colors, better for portraits"
      echo "                         - Stable: More conservative, better for landscapes"
      echo "  --render_factor NUM    Quality factor (default: 35)"
      echo "  -h, --help             Show this help"
      echo ""
      echo "Example:"
      echo "  widget-deoldify 'https://images.pexels.com/photos/1169754/pexels-photo-1169754.jpeg'"
      echo "  widget-deoldify --model_name Stable 'https://example.com/old-photo.jpg'"
      echo ""
      echo "Note: Some image sources may be blocked. Pexels images are recommended."
      exit 0
      ;;
    -*) echo "Unknown option: $1"; exit 1 ;;
    *) INPUT_IMAGE="$1"; shift ;;
  esac
done

if [ -z "$INPUT_IMAGE" ]; then
  echo "Error: No input_image provided"
  echo "Usage: widget-deoldify [options] <image_url>"
  exit 1
fi

if [ -z "$API_KEY" ]; then
  echo "Error: API key not configured"
  exit 1
fi

# Ensure model_name is capitalized correctly
case "${MODEL_NAME,,}" in
  artistic) MODEL_NAME="Artistic" ;;
  stable) MODEL_NAME="Stable" ;;
esac

# Build input JSON
INPUT_JSON=$(jq -n \
  --arg input_image "$INPUT_IMAGE" \
  --arg model_name "$MODEL_NAME" \
  --arg render_factor "$RENDER_FACTOR" \
  '{input_image: $input_image, model_name: $model_name, render_factor: $render_factor}')

# Call Widget API
RESPONSE=$(curl -s -X POST "$API_BASE/public/v2/widget/run" \
  -H "x-myshell-openapi-key: $API_KEY" \
  -H "x-myshell-openapi-user-id: $USER_ID" \
  -H "x-myshell-caller-service: shellclawdbot" \
  -H "Content-Type: application/json" \
  --max-time 600 \
  -d "{\"widget_id\":\"$WIDGET_ID\",\"input\":$(echo "$INPUT_JSON" | jq -Rs .)}")

# Check for error
if echo "$RESPONSE" | jq -e '.message' > /dev/null 2>&1; then
  ERROR=$(echo "$RESPONSE" | jq -r '.message // "Unknown error"')
  echo "Error: $ERROR" >&2
  exit 1
fi

# Extract result
RESULT=$(echo "$RESPONSE" | jq -r '.result // empty')
if [ -z "$RESULT" ]; then
  echo "Error: No result in response" >&2
  echo "$RESPONSE" >&2
  exit 1
fi

# Get output URL/data
OUTPUT_DATA=$(echo "$RESULT" | jq -r '.file_url // .file_urls[0] // empty')
if [ -z "$OUTPUT_DATA" ]; then
  OUTPUT_DATA=$(echo "$RESULT" | jq -r 'if type == "string" then . elif .url then .url elif .file_urls[0] then .file_urls[0] else empty end')
fi

if [ -z "$OUTPUT_DATA" ]; then
  echo "Error: No output data in result" >&2
  echo "$RESULT" >&2
  exit 1
fi

# Output result
if [ -n "$OUTPUT" ]; then
  curl -s -o "$OUTPUT" "$OUTPUT_DATA"
  echo "$OUTPUT"
else
  echo "$OUTPUT_DATA"
fi
